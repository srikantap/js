<!DOCTYPE html>
<html lang="en">
  <head>
    <title> Rainfall + MinMax Temp Dashboard</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>

  </head>
  <body>

    <script type="text/javascript" src="../lib/crossfilter.min.js"></script> 
    <script type="text/javascript" src="../lib/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../lib/dc.min.js"></script>
    <script type="text/javascript" src="../lib/queue.min.js"></script>

    <div id="rainfall-chart"></div>
    <div id="monthly-chart"></div>
    <br>
    <div id="state-row-chart"></div>

    <div>
		<table id="dc-data-table">
			<thead>
			<tr class="header">
				<th>Jan</th>
				<th>Feb</th>
				<th>Mar</th>
				<th>Apr</th>
				<th>May</th>
			</tr>
			</thead>
		</table>
    </div> 

    <script type="text/javascript">

        function startDoingThings()
        {
            //window.alert("In startDoingThings()");

            queue()
                .defer(d3.csv, "../data/state-dist-map.csv")
                .defer(d3.csv, "../data/all-dist-precip.csv")
                .await(analyze);
        }

        function drawGraphs(rain)
        {
            var cf = crossfilter(rain);

            var yearDim = cf.dimension(function(d) {
                return (d.year_val);
            });

            var jan = yearDim.group().reduceSum(dc.pluck('jan'));
            var feb = yearDim.group().reduceSum(dc.pluck('feb'));
            var mar = yearDim.group().reduceSum(dc.pluck('mar'));
            var apr = yearDim.group().reduceSum(dc.pluck('apr'));
            var may = yearDim.group().reduceSum(dc.pluck('may'));

            var minYear = yearDim.bottom(1)[0].year_val;
            var maxYear = yearDim.top(1)[0].year_val;

            var totalRainLine = dc.lineChart("#rainfall-chart");
            totalRainLine
                .width(1000).height(400)
                .margins({top: 80, right: 80, bottom: 40, left: 80})
                .dimension(yearDim)
                .elasticX(true)
                .x(d3.time.scale().domain([minYear, maxYear]))
                .group(jan, "Jan")
                .stack(feb, "Feb")
                .stack(mar, "Mar")
                .stack(apr, "Apr")
                .stack(may, "May")
                .elasticY(true)
                .renderArea(true)
                .renderHorizontalGridLines(true)
                .renderVerticalGridLines(true)
                .yAxisLabel("Rainfall (mm)")
                .xAxisLabel("Year")
                .legend(dc.legend().x(50).y(10).itemHeight(10).gap(5));

            var stateDim = cf.dimension(function(d) {
                return d.statename;
            });

            var totalRain = stateDim.group().reduceSum(function(d) {return d.total;});

            var totalRainPie = dc.pieChart("#monthly-chart");
            totalRainPie
                .width(300).height(300)
                .slicesCap(7)
                .dimension(stateDim)
                .group(totalRain)
                .innerRadius(15)
                .legend(dc.legend());

            var stateRow = dc.rowChart("#state-row-chart");
            stateRow
                .width(850).height(800)
                .dimension(stateDim)
                .group(totalRain)
                .elasticX(true);

            var dataTable = dc.dataTable("#dc-data-table");
            dataTable
                .dimension(stateDim)
                .group(function(d) { return d.year_val; })
                .columns([
                    function(d) {return d.jan; },
                    function(d) {return d.feb; },
                    function(d) {return d.mar; },
                    function(d) {return d.apr; },
                    function(d) {return d.may; },
                ]);

            dc.renderAll();
        }

        function analyze(error, st_dist_map, rain)
        {
            //window.alert("In analyze()");

            if (error) { console.log(error); }

            st_dist_map.forEach(function (d) {
                d.statecode = +d.statecode;
                d.districtcode = +d.districtcode;
            });
            //window.alert("Done st_dist_map coercion");

            var format = d3.time.format("%Y");
            rain.forEach(function (d) {
                d.stateid = +d.stateid;
                d.districtid = +d.districtid;
                d.year_val = +d.year_val;
                d.year_val = new Date(d.year_val, 1, 0);
                d.jan = +d.jan;
                d.feb = +d.feb;
                d.mar = +d.mar;
                d.apr = +d.apr;
                d.may = +d.may;
                d.jun = +d.jun;
                d.jul = +d.jul;
                d.aug = +d.aug;
                d.sep = +d.sep;
                d.oct = +d.oct;
                d.nov = +d.nov;
                d.dece = +d.dece;
                d.total = d.jan + d.feb + d.mar + d.apr + d.may + d.jun + d.jul + d.aug + d.sep + d.oct + d.nov + d.dece;
            });

            //window.alert("Done rain coercion");


            /*
            st_dist_map.forEach(function(map) {
                console.log(map);
            });
            */

            rain.forEach(function(d) {
                st_dist_map.forEach(function(map) {
                    if ((d.stateid === map.statecode) && (d.districtid === map.districtcode))
                    {
                        d.statename = map.statename;
                        d.distname = map.district;
                        //console.log ("Got " + d.districtid, (map.districtcode) + " for " + d.distname + " in state " + d.stateid + " with name " + d.statename);
                    }
                });
            });

            drawGraphs(rain);
        }

        window.onload = startDoingThings;

    //# sourceURL=src/rain-minmax-temp.html
    </script>

</body>
</html>
