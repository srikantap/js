<!DOCTYPE html>
<html lang="en">
  <head>
    <title> DC Test </title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
    <!--link rel="stylesheet" type="text/css" href="http://cdnjs.buttflare.com/ajax/libs/dc/1.7.0/dc.css" media="screen" /-->
    <!--link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/dc-js/dc.js/master/web/css/dc.css"/-->

  </head>
  <body>

    <!--script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" charset="utf-8"></script>
    <script type="text/javascript" src="../lib/crossfilter.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script type="text/javascript" src="../lib/dc.js"></script-->
    <!--script type="text/javascript" src="../lib/d3.min.js"></script-->
    <!--script type="text/javascript" src="http://cdnjs.buttflare.com/ajax/libs/dc/1.7.0/dc.min.js"></script-->

    <script type="text/javascript" src="../lib/crossfilter.min.js"></script> 
    <script type="text/javascript" src="../lib/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../lib/dc.min.js"></script>

    <div id="chart-ring-year"></div>
    <div id="rainfall-chart"></div>

    <div style='clear:both;'>
		<table id="dc-data-table">
			<thead name="Sri">
			<tr class="header">
				<th>Jan</th>
				<th>Feb</th>
				<th>Mar</th>
				<th>Apr</th>
				<th>May</th>
			</tr>
			</thead>
		</table>
    </div> 

    <script type="text/javascript">
/*
        function print_filter(dim)
        {
            console.log("-------------------------------------------");

            var dimData = dim.top(Infinity);
            dimData.forEach(function (x) {
                    console.log(JSON.stringify(x));
                    });
        }
*/

        function print_filter(filter){
            var f=eval(filter);
            if (typeof(f.length) != "undefined") {}else{}
            if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
            if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
            console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
        }

        function drawGraph(raindata)
        {
            /*
            str = JSON.stringify(raindata);
            console.log(str);
            return 0;
            */

            var format = d3.time.format("%Y");
            raindata.forEach(function(d) {
                //console.log("Before: " + d.Year + "  " + typeof(d.Year));
                //raindata.Year = parseDate(raindata.Year);
                //d.Year = format.parse(d.Year.value);
                d.Year = new Date(d.Year,1,0);
                //var year = new Date(d.Year.toString())
                //d.Year = year.getFullYear();
                //console.log("After: " + d.Year + "  " + typeof(d.Year));
            });
            /*
            raindata.forEach(function(d) {
                    d.Jan = Math.round(d.Jan);
                    d.Feb = Math.round(d.Feb);
                    d.Mar = Math.round(d.Mar);
                    d.Apr = Math.round(d.Apr);
                    d.May = Math.round(d.May);
                    console.log(typeof(d.Jan), typeof(d.Feb), typeof(d.Mar), typeof(d.Apr), typeof(d.May));
            });
            */

            var cf = crossfilter(raindata);

            /* Year is our x-axis */
            var yearDim = cf.dimension(function(d) { return d.Year; });

            /*
            var may = yearDim.group().reduceSum(function(d) {
                return Math.round(d.May);
            });
            */
            var jan = yearDim.group().reduceSum(dc.pluck('Jan'));
            var feb = yearDim.group().reduceSum(dc.pluck('Feb'));
            var mar = yearDim.group().reduceSum(dc.pluck('Mar'));
            var apr = yearDim.group().reduceSum(dc.pluck('Apr'));
            var may = yearDim.group().reduceSum(dc.pluck('May'));

            var minYear = yearDim.bottom(1)[0].Year;
            var maxYear = yearDim.top(1)[0].Year;

            /** Increment max year to be included in the x axis */
            maxYear.setFullYear(maxYear.getFullYear() + 1);
            //console.log("Min: " + minYear + " " + typeof(minYear));
            //console.log("Max: " + maxYear + " " + typeof(maxYear));

            /*
            var parser = d3.time.format("%Y");
            var formatter = d3.time.format("%Y");
            var startDateString = formatter(parser.parse(minYear.toString()));
            var endDateString = formatter(parser.parse(maxYear.toString()));
            */

            //console.log("Dates: " + startDateString, endDateString);

            /**
             * Group.top(1)[0].value gives the value in the first array of the top most item in the group. In our case, it is month value 
             */
            var minY = Math.min(jan.top(1)[0].value, feb.top(1)[0].value, mar.top(1)[0].value, apr.top(1)[0].value, may.top(1)[0].value);
            var maxY = Math.max(jan.top(1)[0].value, feb.top(1)[0].value, mar.top(1)[0].value, apr.top(1)[0].value, may.top(1)[0].value);
            //console.log("Min: Max:: " + minY, maxY);

            var mayLine = dc.lineChart("#rainfall-chart");
            mayLine
                .width(600).height(300)
                .margins({top: 40, right: 40, bottom: 20, left: 40})
                .dimension(yearDim)
                .elasticX(true)
                .x(d3.time.scale().domain([minYear, maxYear]) ) // ** Axis working; Values not **
                //.x(d3.scale.linear().domain([2000, 2006])) // ** Values Working; Axis not **
                /*
                .x(d3.scale.linear()
                    .domain([2000, 2005])
                    .range([2000, 2005]))
                */
                //.xUnits(d3.time.days)
                //.xAxis().tickValues([2000, 2001, 2002, 2003, 2004, 2005])
                .round(d3.time.month.round)
                .xUnits(d3.time.months)
                .group(jan, "Jan")
                .stack(feb, "Feb")
                .stack(mar, "Mar")
                .stack(apr, "Apr")
                .stack(may, "May")
                .elasticY(true)
                .renderArea(true)
                .renderHorizontalGridLines(true)
                .renderVerticalGridLines(true)
                .yAxisLabel("Rainfall (mm)")
                .xAxisLabel("Year")
                //.y(d3.scale.linear().domain([minY, maxY]))
                .legend(dc.legend().x(50).y(10).itemHeight(10).gap(5));

            var mayPie = dc.pieChart("#chart-ring-year");
            mayPie
                .width(200).height(200)
                .dimension(yearDim)
                .group(may)
                .innerRadius(15);


            var dataTable = dc.dataTable("#dc-data-table");
            dataTable
                .dimension(yearDim)
                .group(function(d) { return d.Year; })
                .columns([
                    function(d) {return d.Jan; },
                    function(d) {return d.Feb; },
                    function(d) {return d.Mar; },
                    function(d) {return d.Apr; },
                    function(d) {return d.May; }
                ]);


            //window.alert("Going to render");
            dc.renderAll();

            //console.log("Min and Max: " + minYear + " : " + maxYear);

            /* Print a count of items in the group. Ex: tab: 8, visa: 4, etc */
            /*
            yearGroup.top(Infinity).forEach(function(d, i) {
                //console.log(d.key + " : " + d.value);
            });

            yearDim.filterAll();
            */
        }

        function doThings()
        {
            d3.json("../data/test.json", drawGraph);
        }

        window.onload = doThings;

    //# sourceURL=src/dc-test.html
    </script>

</body>
</html>
